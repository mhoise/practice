<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Practice Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    :root { --pico-font-size: 16px; }
    body { min-height: 100vh; }
    .container { max-width: 700px; padding: 2rem 1rem; }
    .hidden { display: none !important; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
    .stat { text-align: center; padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); }
    .stat-value { font-size: 2rem; font-weight: 600; line-height: 1.2; }
    .stat-label { font-size: 0.875rem; color: var(--pico-muted-color); }
    .code-display { font-family: var(--pico-font-family-monospace); font-size: 1.5rem; text-align: center; padding: 1.5rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); margin-bottom: 0.5rem; letter-spacing: 0.1em; }
    .code-help { font-size: 0.875rem; color: var(--pico-muted-color); text-align: center; margin-bottom: 2rem; }
    .status-approved { color: var(--pico-ins-color); }
    .status-pending { color: #f59e0b; }
    .status-rejected, .status-missed { color: var(--pico-del-color); }
    .result { margin-top: 1rem; padding: 1rem; border-radius: var(--pico-border-radius); }
    .result.success { background: color-mix(in srgb, var(--pico-ins-color) 15%, transparent); }
    .result.error { background: color-mix(in srgb, var(--pico-del-color) 15%, transparent); }
    .result.warning { background: color-mix(in srgb, #f59e0b 15%, transparent); }
    .submission-card { padding: 1rem; margin-bottom: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); }
    .submission-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .ai-warning { color: var(--pico-del-color); font-weight: 600; }
    .btn-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .btn-group button { flex: 1; }
    video { width: 100%; max-height: 400px; background: #000; border-radius: var(--pico-border-radius); margin: 1rem 0; }
    .consequence-box { padding: 1.5rem; background: color-mix(in srgb, var(--pico-del-color) 10%, transparent); border: 2px solid var(--pico-del-color); border-radius: var(--pico-border-radius); margin: 2rem 0; text-align: center; }
    .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .nav-header h1 { margin: 0; }
    .saturday-warning { padding: 1rem; background: color-mix(in srgb, #f59e0b 15%, transparent); border-radius: var(--pico-border-radius); margin-bottom: 1rem; }
    .storage-indicator { margin-bottom: 1.5rem; }
    .storage-bar { height: 8px; background: var(--pico-muted-border-color); border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem; }
    .storage-used { height: 100%; background: var(--pico-primary); transition: width 0.3s; }
    .storage-used.warning { background: #f59e0b; }
    .storage-used.critical { background: var(--pico-del-color); }
    .storage-text { font-size: 0.875rem; color: var(--pico-muted-color); }
    .submissions-list { margin-top: 1.5rem; }
    .submission-card { padding: 1rem; margin-bottom: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); border: 1px solid var(--pico-muted-border-color); }
    .submission-card.pending { border-left: 4px solid #f59e0b; }
    .submission-card.approved { border-left: 4px solid var(--pico-ins-color); }
    .submission-card.rejected { border-left: 4px solid var(--pico-del-color); }
    .submission-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem; }
    .submission-week { font-weight: 600; }
    .submission-size { font-size: 0.875rem; color: var(--pico-muted-color); }
    .submission-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
    .submission-actions button { flex: 1; min-width: 80px; padding: 0.5rem 1rem; font-size: 0.875rem; }
    .danger-zone { margin-top: 2rem; }
    .danger-zone summary { cursor: pointer; color: var(--pico-del-color); font-weight: 600; }
    .danger-zone-content { padding: 1rem; margin-top: 1rem; background: color-mix(in srgb, var(--pico-del-color) 10%, transparent); border: 1px solid var(--pico-del-color); border-radius: var(--pico-border-radius); }
    .danger-zone-content p { margin-bottom: 1rem; color: var(--pico-muted-color); }
  </style>
</head>
<body>
  <main class="container">
    <!-- Login View -->
    <section id="login-view">
      <h1>Practice Tracker</h1>
      <form id="login-form">
        <label>
          Username
          <input type="text" name="username" required autocomplete="username">
        </label>
        <label>
          Password
          <input type="password" name="password" required autocomplete="current-password">
        </label>
        <button type="submit">Log in</button>
      </form>
      <div id="login-error" class="result error hidden"></div>
    </section>

    <!-- Friend View -->
    <section id="friend-view" class="hidden">
      <div class="nav-header">
        <h1>Practice Tracker</h1>
        <button class="outline" id="logout-btn">Log out</button>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="days-left">--</div>
          <div class="stat-label">days left</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="weeks-left">--</div>
          <div class="stat-label">weeks left</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="streak">--</div>
          <div class="stat-label">week streak</div>
        </div>
      </div>

      <div id="saturday-warning" class="saturday-warning hidden">
        Today is Saturday. Deadline is Monday at midnight. Submit your video.
      </div>

      <section id="submit-section">
        <h2>This Week</h2>
        <p id="week-status"></p>
        <div id="code-section">
          <div class="code-display" id="weekly-code">------</div>
          <p class="code-help">Write this code on paper and show it in your video</p>
        </div>
        <form id="upload-form">
          <label>
            Upload practice video
            <input type="file" id="video" name="video" accept="video/*" required>
          </label>
          <button type="submit" id="submit-btn">Submit for review</button>
        </form>
        <div id="submit-result" class="result hidden"></div>
      </section>

      <section id="already-submitted" class="hidden">
        <h2>This Week</h2>
        <p id="submission-status"></p>
      </section>

      <section id="well-done-section" class="hidden">
        <div style="text-align: center; padding: 2rem 0;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸŽ‰</div>
          <h2 style="color: var(--pico-ins-color); margin-bottom: 0.5rem;">Well Done!</h2>
          <p style="color: var(--pico-muted-color);">Your practice video has been approved. See you next week!</p>
        </div>
      </section>
    </section>

    <!-- Admin View -->
    <section id="admin-view" class="hidden">
      <div class="nav-header">
        <h1>Admin Dashboard</h1>
        <button class="outline" id="admin-logout-btn">Log out</button>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="admin-streak">--</div>
          <div class="stat-label">current streak</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="admin-days-left">--</div>
          <div class="stat-label">days left</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="consequences-count">--</div>
          <div class="stat-label">consequences</div>
        </div>
      </div>

      <!-- Storage Indicator -->
      <div class="storage-indicator">
        <div class="storage-bar">
          <div class="storage-used" id="storage-bar-fill" style="width: 0%"></div>
        </div>
        <span class="storage-text" id="storage-text">Loading storage...</span>
      </div>

      <div id="consequence-section" class="consequence-box hidden">
        <h3>Deadline Missed</h3>
        <p id="consequence-text">No approved submission last week. You can trigger the consequence.</p>
        <button id="trigger-consequence-btn" class="contrast">Trigger Consequence ($5)</button>
        <p id="consequence-result" style="margin-top: 1rem;"></p>
      </div>

      <div id="this-week-status" style="padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
        <h3 style="margin-top:0;">This Week</h3>
        <p id="admin-week-status">Loading...</p>
      </div>

      <!-- Submissions List -->
      <div class="submissions-list">
        <h3>All Submissions</h3>
        <div id="submissions-container">
          <p style="color: var(--pico-muted-color);">Loading submissions...</p>
        </div>
      </div>

      <!-- Danger Zone -->
      <details class="danger-zone">
        <summary>Danger Zone</summary>
        <div class="danger-zone-content">
          <p>These actions are irreversible. Use with caution.</p>
          <button id="clear-all-btn" class="contrast">Clear All Submissions</button>
        </div>
      </details>
    </section>
  </main>

  <script>
    let currentUser = null;

    async function checkAuth() {
      try {
        const res = await fetch('/api/me');
        if (res.ok) {
          currentUser = await res.json();
          showView(currentUser.role);
        } else {
          showView('login');
        }
      } catch {
        showView('login');
      }
    }

    function showView(view) {
      document.getElementById('login-view').classList.toggle('hidden', view !== 'login');
      document.getElementById('friend-view').classList.toggle('hidden', view !== 'friend');
      document.getElementById('admin-view').classList.toggle('hidden', view !== 'admin');

      if (view === 'friend') loadFriendDashboard();
      if (view === 'admin') loadAdminDashboard();
    }

    // Login
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const errorEl = document.getElementById('login-error');

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: form.username.value,
            password: form.password.value,
          }),
        });

        const data = await res.json();
        if (res.ok) {
          currentUser = { role: data.role };
          showView(data.role);
        } else {
          errorEl.textContent = data.error;
          errorEl.classList.remove('hidden');
        }
      } catch (err) {
        errorEl.textContent = 'Login failed';
        errorEl.classList.remove('hidden');
      }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.getElementById('admin-logout-btn').addEventListener('click', logout);

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      currentUser = null;
      showView('login');
    }

    // Friend dashboard
    async function loadFriendDashboard() {
      try {
        const res = await fetch('/api/dashboard');
        const data = await res.json();

        document.getElementById('days-left').textContent = data.daysUntilWedding;
        document.getElementById('weeks-left').textContent = data.weeksUntilWedding;
        document.getElementById('streak').textContent = data.streak;
        document.getElementById('weekly-code').textContent = data.weeklyCode;

        const saturdayWarning = document.getElementById('saturday-warning');
        saturdayWarning.classList.toggle('hidden', !data.isSaturday || data.thisWeekStatus !== 'not_submitted');

        const submitSection = document.getElementById('submit-section');
        const alreadySection = document.getElementById('already-submitted');
        const wellDoneSection = document.getElementById('well-done-section');
        const statusEl = document.getElementById('submission-status');

        // Hide all sections first
        submitSection.classList.add('hidden');
        alreadySection.classList.add('hidden');
        wellDoneSection.classList.add('hidden');

        if (data.thisWeekStatus === 'approved') {
          // Show well done section
          wellDoneSection.classList.remove('hidden');
        } else if (data.thisWeekStatus === 'not_submitted') {
          submitSection.classList.remove('hidden');
          const deadline = new Date(data.deadline);
          document.getElementById('week-status').innerHTML =
            `Due by ${deadline.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })} at midnight`;
        } else if (data.thisWeekStatus === 'pending') {
          alreadySection.classList.remove('hidden');
          statusEl.innerHTML = `<span class="status-pending">Submitted - waiting for review</span>`;
        } else if (data.thisWeekStatus === 'rejected') {
          alreadySection.classList.remove('hidden');
          submitSection.classList.remove('hidden');
          statusEl.innerHTML = `<span class="status-rejected">Rejected - you can submit again</span>`;
        }
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }

    // Upload
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById('video');
      const submitBtn = document.getElementById('submit-btn');
      const resultEl = document.getElementById('submit-result');

      if (!fileInput.files[0]) return;

      submitBtn.disabled = true;
      submitBtn.setAttribute('aria-busy', 'true');
      submitBtn.textContent = 'Uploading & analyzing...';
      resultEl.classList.add('hidden');

      const formData = new FormData();
      formData.append('video', fileInput.files[0]);

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          body: formData,
        });

        const data = await res.json();
        resultEl.classList.remove('hidden', 'success', 'error', 'warning');

        if (data.success) {
          resultEl.classList.add('success');
          resultEl.textContent = 'Submitted for review.';
          setTimeout(loadFriendDashboard, 1500);
        } else {
          resultEl.classList.add('error');
          resultEl.textContent = data.error || 'Submission failed';
        }
      } catch {
        resultEl.classList.remove('hidden');
        resultEl.classList.add('error');
        resultEl.textContent = 'Upload failed';
      } finally {
        submitBtn.disabled = false;
        submitBtn.removeAttribute('aria-busy');
        submitBtn.textContent = 'Submit for review';
      }
    });

    // Admin dashboard
    async function loadAdminDashboard() {
      try {
        const [dashRes, deadlineRes, storageRes, subsRes] = await Promise.all([
          fetch('/api/dashboard'),
          fetch('/api/admin/deadline-status'),
          fetch('/api/admin/storage'),
          fetch('/api/admin/submissions')
        ]);

        if (!dashRes.ok || !deadlineRes.ok) {
          console.error('Dashboard API error');
          return;
        }

        const data = await dashRes.json();
        const deadlineData = await deadlineRes.json();
        const storageData = storageRes.ok ? await storageRes.json() : null;
        const submissions = subsRes.ok ? await subsRes.json() : [];

        document.getElementById('admin-streak').textContent = data.streak ?? 0;
        document.getElementById('admin-days-left').textContent = data.daysUntilWedding ?? 0;
        document.getElementById('consequences-count').textContent = deadlineData.consequencesCount ?? 0;

        // Storage indicator
        if (storageData) {
          const storageBar = document.getElementById('storage-bar-fill');
          const storageText = document.getElementById('storage-text');
          storageBar.style.width = `${Math.min(storageData.percentage, 100)}%`;
          storageBar.classList.remove('warning', 'critical');
          if (storageData.percentage >= 90) storageBar.classList.add('critical');
          else if (storageData.percentage >= 80) storageBar.classList.add('warning');
          storageText.textContent = `${storageData.usedMB} MB / ${storageData.totalMB} MB (${storageData.percentage}%) - ${storageData.fileCount} videos`;
        }

        // This week status
        const statusEl = document.getElementById('admin-week-status');
        const statusClass = `status-${data.thisWeekStatus || 'not_submitted'}`;
        const statusText = {
          not_submitted: 'No submission yet',
          pending: 'Pending review',
          approved: 'Approved',
          rejected: 'Rejected - waiting for resubmission',
        }[data.thisWeekStatus] || 'No submission yet';
        statusEl.innerHTML = `<span class="${statusClass}">${statusText}</span>`;

        // Consequence section (for previous week's missed deadline)
        const consequenceSection = document.getElementById('consequence-section');
        if (deadlineData.canTriggerConsequence) {
          consequenceSection.classList.remove('hidden');
          document.getElementById('consequence-text').textContent =
            `No approved submission for ${deadlineData.previousWeek}. You can trigger the consequence.`;
        } else {
          consequenceSection.classList.add('hidden');
        }

        // Render submissions list
        renderSubmissions(submissions, data.currentWeek);

      } catch (err) {
        console.error('Admin dashboard error:', err);
      }
    }

    function renderSubmissions(submissions, currentWeek) {
      const container = document.getElementById('submissions-container');

      if (submissions.length === 0) {
        container.innerHTML = '<p style="color: var(--pico-muted-color);">No submissions yet.</p>';
        return;
      }

      container.innerHTML = submissions.map(sub => {
        const date = new Date(sub.submittedAt);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const sizeStr = sub.videoSize ? `${(sub.videoSize / 1024 / 1024).toFixed(1)} MB` : '';
        const isCurrentWeek = sub.week === currentWeek;

        const statusBadge = {
          pending: '<span class="status-pending">Pending</span>',
          approved: '<span class="status-approved">Approved</span>',
          rejected: '<span class="status-rejected">Rejected</span>',
        }[sub.status] || '';

        const actionButtons = sub.status === 'pending' ? `
          <button class="secondary" onclick="approveSubmission('${sub.id}')">Approve</button>
          <button class="secondary" onclick="rejectSubmission('${sub.id}')">Reject</button>
        ` : '';

        return `
          <div class="submission-card ${sub.status}">
            <div class="submission-meta">
              <span class="submission-week">${sub.week}${isCurrentWeek ? ' (current)' : ''}</span>
              <span>${statusBadge}</span>
            </div>
            <div style="font-size: 0.875rem; color: var(--pico-muted-color); margin-bottom: 0.5rem;">
              Submitted: ${dateStr} ${sizeStr ? `| ${sizeStr}` : ''}
            </div>
            ${sub.videoFileId ? `
              <video controls preload="metadata">
                <source src="/api/videos/${sub.id}" type="video/mp4">
                Your browser does not support video playback.
              </video>
            ` : '<p style="color: var(--pico-muted-color);">No video available</p>'}
            <div class="submission-actions">
              ${actionButtons}
              <button class="outline contrast" onclick="deleteSubmission('${sub.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function approveSubmission(id) {
      if (!confirm('Approve this submission?')) return;
      try {
        const res = await fetch(`/api/admin/submissions/${id}/approve`, { method: 'POST' });
        if (res.ok) {
          loadAdminDashboard();
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to approve');
        }
      } catch {
        alert('Failed to approve submission');
      }
    }

    async function rejectSubmission(id) {
      if (!confirm('Reject this submission?')) return;
      try {
        const res = await fetch(`/api/admin/submissions/${id}/reject`, { method: 'POST' });
        if (res.ok) {
          loadAdminDashboard();
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to reject');
        }
      } catch {
        alert('Failed to reject submission');
      }
    }

    async function deleteSubmission(id) {
      if (!confirm('Delete this submission? This will also delete the video. This cannot be undone.')) return;
      try {
        const res = await fetch(`/api/admin/submissions/${id}`, { method: 'DELETE' });
        if (res.ok) {
          loadAdminDashboard();
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to delete');
        }
      } catch {
        alert('Failed to delete submission');
      }
    }

    document.getElementById('clear-all-btn').addEventListener('click', async () => {
      const confirmation = prompt('Type "DELETE ALL" to confirm clearing all submissions and videos:');
      if (confirmation !== 'DELETE ALL') {
        alert('Cancelled. You must type "DELETE ALL" exactly.');
        return;
      }

      try {
        const res = await fetch('/api/admin/submissions?confirm=true', { method: 'DELETE' });
        if (res.ok) {
          alert('All submissions cleared.');
          loadAdminDashboard();
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to clear submissions');
        }
      } catch {
        alert('Failed to clear submissions');
      }
    });

    document.getElementById('trigger-consequence-btn').addEventListener('click', async () => {
      if (!confirm('Trigger consequence? This will reset the streak and notify Victor to pay $5.')) {
        return;
      }

      try {
        const res = await fetch('/api/admin/trigger-consequence', { method: 'POST' });
        const data = await res.json();

        const resultEl = document.getElementById('consequence-result');
        if (res.ok) {
          resultEl.innerHTML = `Consequence triggered. Victor has been notified. <a href="${data.paypalLink}" target="_blank">PayPal link ($5)</a>`;
          loadAdminDashboard();
        } else {
          resultEl.textContent = data.error;
        }
      } catch {
        document.getElementById('consequence-result').textContent = 'Failed to trigger';
      }
    });

    // Init
    checkAuth();
  </script>
</body>
</html>
